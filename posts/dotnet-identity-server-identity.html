<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preload" as="style" href='/scss/clean-blog-min.css'/>

    <meta name="description" content="4.&#x81EA;&#x8A02;.NET Core Identity&#x8EAB;&#x4EFD;&#x9A57;&#x8B49;&#x548C;&#x6388;&#x6B0A;&#x6559;&#x5B78;&#xFF1A;Identity Server With ASP.NET Core Identity">

  <title>&#x81EA;&#x8A02;.NET Core Identity&#x8EAB;&#x4EFD;&#x9A57;&#x8B49;&#x548C;&#x6388;&#x6B0A;&#x6559;&#x5B78;&#xFF1A;Identity Server With ASP.NET Core Identity</title>


  <link rel="canonical" href='https://blog.allengaodev.com/posts/dotnet-identity-server-identity'>

      <link type="application/rss+xml" rel="alternate" title="&#x958B;&#x767C;&#x7A7A;&#x9593;" href="/feed.rss" />
      <link type="application/atom+xml" rel="alternate" title="&#x958B;&#x767C;&#x7A7A;&#x9593;" href="/feed.atom" />

  <meta name="application-name" content='Gao.Dev' />
  <meta name="msapplication-tooltip" content='Gao.Dev' />
  <meta name="msapplication-starturl" content='/' />
  <meta name="google-site-verification" content="aq71qXzppLuXZ8be8mjOwn_zJq317ZSD34yTS4i6y6M" />
  <meta property="og:title" content='&#x81EA;&#x8A02;.NET Core Identity&#x8EAB;&#x4EFD;&#x9A57;&#x8B49;&#x548C;&#x6388;&#x6B0A;&#x6559;&#x5B78;&#xFF1A;Identity Server With ASP.NET Core Identity' />
  <meta property="og:type" content="website" />
  <meta property="og:url" content='https://blog.allengaodev.com/posts/dotnet-identity-server-identity' />

  <link rel="icon" href='/favicon.svg'>

  <!-- Styles for this template (also includes Bootstrap) -->
  <link href='/scss/clean-blog-min.css' rel="stylesheet">

  


  

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand navbar-light" id="mainNav" style="background-color: #F5F1E6">
  <div class="container">
    <a class="navbar-brand text-dark" href='/'> Home </a>

    <div class="navbar-nav-container" id="navbarResponsive">
      <ul class="navbar-nav ms-auto">
          <li class="nav-item">
    <a class="nav-link text-dark" href="/search">Search</a>
  </li>
  <li class="nav-item">
    <a class="nav-link text-dark" href="/posts">Posts</a>
  </li>
  <li class="nav-item">
    <a class="nav-link text-dark" href="/tags">Tags</a>
  </li>

      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->
  <header class="masthead no-image">
  <div class="container position-relative">
    <div class="row">
      <div class="col-md-12">
        <div class='post-heading'>
          <h1>
            <a style="color:white" href='https://blog.allengaodev.com/posts/dotnet-identity-server-identity'>&#x81EA;&#x8A02;.NET Core Identity&#x8EAB;&#x4EFD;&#x9A57;&#x8B49;&#x548C;&#x6388;&#x6B0A;&#x6559;&#x5B78;&#xFF1A;Identity Server With ASP.NET Core Identity</a>
          </h1>
            <p class="post-meta">
              <a style="line-height: 1.8em;padding-left: 1.6em;background-size: auto 100%;background-repeat: no-repeat; background-image:url(/calendar.svg)">
                2023/05/09
              </a>

                <a style="line-height: 1.8em;padding-left: 1.6em;background-size: auto 100%;background-repeat: no-repeat; background-image:url(/overtime.svg)">
                  2025/08/22
                </a>
            </p>
              <div class="mt-3">
                  <a href="/tags/dotnet" class="badge bg-white text-dark"> Dotnet</a>
                  <a href="/tags/csharp" class="badge bg-white text-dark"> CSharp</a>
                  <a href="/tags/identity" class="badge bg-white text-dark"> Identity</a>
              </div>
        </div>
      </div>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <main id="main-content">
    <div class="container">
      <div class="row">
        <div id="content" class="col-md-12">
          <h2 id="identity-server-with-asp.net-core-identity">Identity Server With ASP.NET Core Identity</h2>
<p>到目前為止 Identity Server 基礎部份都學習過了，但是還缺少會員的添加與管理方式，由於我們之前使用 TestUsers 寫死兩個會員資料，
在實務中還是要動態新增會員的方式，這時候就可以加入 ASP.NET Core Identity 功能，不過要處理這部份需要對 ASP.NET Core Identity 有相當程度的了解，
本系列一開始有討論過了有需要的可以回去看看</p>
<p>要在 IdentityServer 使用 ASP.NET Core Identity 可以使用預設的範本 <code>duende-is-aspid</code> 來建立專案</p>
<pre><code class="language-text">範本名稱                                                    簡短名稱  語言  標記
----------------------------------------------------------  --------------------  ----  -------------------------
Duende BFF Host using a Remote API                          duende-bff-remoteapi  [C#]  Web/Duende/BFF
Duende BFF using a Local API                                duende-bff-localapi   [C#]  Web/Duende/BFF
Duende BFF with Blazor autorender                           duende-bff-blazor     [C#]  Web/Duende/BFF
Duende IdentityServer                                       duende-is             [C#]  Web/Duende/IdentityServer
Duende IdentityServer Empty                                 duende-is-empty       [C#]  Web/Duende/IdentityServer
Duende IdentityServer Quickstart UI (UI assets only)        duende-is-ui          [C#]  Web/IdentityServer
Duende IdentityServer Web Client                            duende-webclient      [C#]  Web/Duende/IdentityServer
Duende IdentityServer with ASP.NET Core Identity            duende-is-aspid       [C#]  Web/Duende/IdentityServer
Duende IdentityServer with Entity Framework Stores          duende-is-ef          [C#]  Web/Duende/IdentityServer
Duende IdentityServer with In-Memory Stores and Test Users  duende-is-inmem       [C#]  Web/Duende/IdentityServer
</code></pre>
<p>先建立一個新專案來看看跟我們目前的專案有什麼區別</p>
<pre><code class="language-text">dotnet new duende-is-aspid -n IdentityServerAspNetIdentity
cd ..
dotnet sln add ./src/IdentityServerAspNetIdentity/IdentityServerAspNetIdentity.csproj
</code></pre>
<ol>
<li>安裝 Package <code>Duende.IdentityServer.AspNetIdentity</code>, <code>Microsoft.AspNetCore.Identity.EntityFrameworkCore</code>, <code>Microsoft.AspNetCore.Identity.UI</code></li>
<li>wwwroot 與 Pages 資料夾都是 <code>isui</code> 這個範本提供的會幫你在專案添加一些預設頁面</li>
<li>Models 資料夾新建立一個自定義的 IdentityUser 叫做 ApplicationUser</li>
<li>專案使用 SQLite 並建立了相關檔案</li>
<li>Data 資料夾新建立一個自定義的 IdentityDbContext 叫做 ApplicationDbContext</li>
<li>buildschema.bat 會自動建立遷移腳本並輸出到 <code>Data/Migrations</code> 資料夾</li>
<li>SeedData 內部會使用 UserManager 提供的方法來新增預設會員數據</li>
<li>HostingExtensions 注入並使用 ApplicationDbContext</li>
<li>額外呼叫 AddAspNetIdentity 方法設定 Identity 相關功能並且呼叫 <code>AddResourceOwnerValidator</code> 與 <code>AddProfileService</code></li>
</ol>
<p>了解後回到原本的 IdentityServer 專案我們來進行實做</p>
<p>首先添加需要用到的 Package</p>
<pre><code class="language-text">dotnet add package Duende.IdentityServer.AspNetIdentity
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore
dotnet add package Microsoft.AspNetCore.Identity.UI
</code></pre>
<p>建立 DbContext</p>
<pre><code class="language-text">namespace IdentityServer.Data;

public class AppIdentityDbContext : IdentityDbContext&lt;IdentityUser&gt;
{
    public AppIdentityDbContext(DbContextOptions&lt;AppIdentityDbContext&gt; options) : base(options)
    {
        
    }
}
</code></pre>
<p>將 AppIdentityDbContext 註冊到系統內，並且將 <code>AddTestUsers</code> 替換成 <code>AddAspNetIdentity</code></p>
<pre><code class="language-text">const string connectionIdentity = &#64;&quot;User ID=postgres;Password=myPassw0rd;Host=localhost;Port=5432;Database=IdentityServerIdentity;Pooling=false;&quot;;

builder.Services.AddDbContext&lt;AppIdentityDbContext&gt;(options =&gt;
    options.UseNpgsql(connectionIdentity));

builder.Services.AddIdentity&lt;IdentityUser, IdentityRole&gt;()
    .AddDefaultUI()
    .AddDefaultTokenProviders()
    .AddEntityFrameworkStores&lt;AppIdentityDbContext&gt;();
    
builder.Services.AddIdentityServer(options =&gt;
    {
        // https://docs.duendesoftware.com/identityserver/v6/fundamentals/resources/api_scopes#authorization-based-on-scopes
        options.EmitStaticAudienceClaim = true;
    })
    .AddConfigurationStore(options =&gt;
    {
        options.ConfigureDbContext = b =&gt; b.UseNpgsql(connectionStringConfigure,
            sql =&gt; sql.MigrationsAssembly(migrationsAssembly));
    })
    .AddOperationalStore(options =&gt;
    {
        options.ConfigureDbContext = b =&gt; b.UseNpgsql(connectionStringOperational,
            sql =&gt; sql.MigrationsAssembly(migrationsAssembly));
    })
    .AddClientStore&lt;ClientStore&gt;()
    .AddAspNetIdentity&lt;IdentityUser&gt;();
</code></pre>
<p>因為要使用 Identity UI 我們需要在專案添加 <code>/Views/Shared/_LoginPartial.cshtml</code> 用來顯示右上角
根據登入狀態顯示 Login 或者 Log out，</p>
<pre><code class="language-text">dotnet new page -np -n _LoginPartial
</code></pre>
<pre><code class="language-text">&#64;if (User.Identity.IsAuthenticated)
{
    &lt;form asp-controller=&quot;Account&quot; asp-action=&quot;Logout&quot; asp-route-returnUrl=&quot;&#64;Url.Action(&quot;Index&quot;, &quot;Home&quot;, new { area = &quot;&quot; })&quot; method=&quot;post&quot; id=&quot;logoutForm&quot; class=&quot;navbar-right&quot;&gt;
        &lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;
            &lt;li class=&quot;navbar-text&quot;&gt;Hello &#64;User.Identity.Name!&lt;/li&gt;
            &lt;li&gt;
                &lt;button type=&quot;submit&quot; class=&quot;btn btn-link navbar-btn navbar-link&quot;&gt;Log out&lt;/button&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
    &lt;/form&gt;
}
else
{
    &lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;
        &lt;li&gt;&lt;a asp-controller=&quot;Account&quot; asp-action=&quot;Login&quot;&gt;Login&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
}
</code></pre>
<p>最後建立遷移腳本並且更新資料庫</p>
<pre><code class="language-text">dotnet ef migrations add InitialIdentityDbMigration -c AppIdentityDbContext -o Data/Migrations/IdentityServer/IdentityDb

dotnet ef database update -c AppIdentityDbContext
</code></pre>
<p>完成後運行 Identity Server 與 WebClient 專案進行測試</p>
<p>在瀏覽器打開 <code>https://localhost:5001/identity/account/register</code> 這個是 identity 預設的註冊路徑
註冊完成後打開 <code>https://localhost:5002</code> 會直接透過 Oidc 轉跳到 <code>https://localhost:5001</code> 要求登入，
這時輸入剛剛註冊的帳號可以正常登入並且跳回到 <code>5002</code> 並顯示目前 User 身上擁有的 Claim</p>
<hr />
<h2 id="summary">Summary</h2>
<p>今天成功將 Identity Server 與 ASP.NET Core Identity 兩個技術結合在一起，
至此我們的功能已經可以做到類似 Google 的 Oidc 伺服器的提供的功能了，不過 Identity Server 還有許多設定可以調整
可以按照自己的需求來做設定</p>


          

        </div>
      </div>
  <div id="comments-container" class="row">
    <div id="giscus-container"></div>

<script>
  let giscusLoaded = false;
  function loadGiscus() {
    if (giscusLoaded) return;
    giscusLoaded = true;

    let datarepo = 'allengaodev/allengaodev.github.io'
    let datarepoid='R_kgDOI6sF8g'
    let datacategoryid='DIC_kwDOI6sF8s4CUbuw'
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.setAttribute('data-repo', datarepo);
    script.setAttribute('data-repo-id', datarepoid);
    script.setAttribute('data-category-id', datacategoryid);
    script.setAttribute("data-mapping", "pathname");
    script.setAttribute("data-strict", "0");
    script.setAttribute("data-reactions-enabled", "1");
    script.setAttribute("data-emit-metadata", "0");
    script.setAttribute("data-input-position", "top");
    script.setAttribute("data-theme", "light");
    script.setAttribute("data-lang", "en");
    script.async = true;
    document.getElementById("giscus-container").appendChild(script);
  }

  // 檢查是否滾動到最底部
  function checkScrollBottom() {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight / 2) {
      loadGiscus();
      window.removeEventListener("scroll", checkScrollBottom);
    }
  }

  // 等待滾動結束
  setTimeout(() => {
    checkScrollBottom();
    window.addEventListener("scroll", checkScrollBottom);
  }, 500); // 0.5秒後檢查
</script>

  </div>
    </div>
  </main>

  <hr>

  <!-- Footer -->
  <footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <p class="copyright">&#xA9; 2026 by Allen Gao</p>

      </div>
    </div>
  </div>
</footer>


  <!-- Scripts -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.min.js"></script>
  <script async src="https://cdn.jsdelivr.net/npm/quicklink@2.3.0/dist/quicklink.umd.js"></script>
  <script defer src='/vendor/startbootstrap-clean-blog/js/scripts.min.js'></script>
  

  
</body>

</html>
