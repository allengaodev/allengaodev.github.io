<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="preconnect" href="https://giscus.app" crossorigin>
  <link rel="preload" as="style" href='/scss/clean-blog-min.css'/>

    <meta name="description" content="Cipher Suites (01:12:00)">

  <title>Module 5 - Cipher Suites</title>


  <link rel="canonical" href='https://blog.allengaodev.com/backlogs/Practical-TLS/module5-cipher-suites'>

      <link type="application/rss+xml" rel="alternate" title="&#x958B;&#x767C;&#x7A7A;&#x9593;" href="/feed.rss" />
      <link type="application/atom+xml" rel="alternate" title="&#x958B;&#x767C;&#x7A7A;&#x9593;" href="/feed.atom" />

  <meta name="application-name" content='Gao.Dev' />
  <meta name="msapplication-tooltip" content='Gao.Dev' />
  <meta name="msapplication-starturl" content='/' />
  <meta name="google-site-verification" content="aq71qXzppLuXZ8be8mjOwn_zJq317ZSD34yTS4i6y6M" />
  <meta property="og:title" content='Module 5 - Cipher Suites' />
    <meta property="og:image" content='/assets/img/101night.avif' />
  <meta property="og:type" content="website" />
  <meta property="og:url" content='https://blog.allengaodev.com/backlogs/Practical-TLS/module5-cipher-suites' />

  <link rel="icon" href='/favicon.svg'>

  <!-- Styles for this template (also includes Bootstrap) -->
  <link href='/scss/clean-blog-min.css' rel="stylesheet">
  <script async src='/vendor/quicklink/js/quicklink.umd.js' onload="quicklink.listen();"></script>
  <script async src='/vendor/prismjs/js/prism-core.min.js'></script>
  <script async src='/vendor/prismjs/js/prism-autoloader.min.js'></script>
  <link href='/vendor/prismjs/css/prism.min.css' rel="stylesheet" media="print" onload="this.media='all'">

  <!-- Google tag (gtag.js)-->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EBB8LGKD99"></script>
  <script> function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-EBB8LGKD99"); </script>

  


  

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href='/'> Home </a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ms-auto">
          <!-- <li class="nav-item">
            <span class="nav-link">
              <form class="form-inline my-2 my-lg-0" action="/search" method="GET">
                <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search" name="query" id="search-query-nav">
                <input type="submit" hidden />
              </form>
            </span>
          </li> -->
          <li class="nav-item">
    <a class="nav-link" href="/search">Search</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/posts">Posts</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/tags">Tags</a>
  </li>

      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->
  <header class="masthead" style="background-image: url(&quot;/assets/img/101night.avif&quot;)">
  <div class="container position-relative">
    <div class="row">
      <div class="col-md-12">
        <div class='site-heading'>
          <h1>
            <a style="color:white" href='https://blog.allengaodev.com/backlogs/Practical-TLS/module5-cipher-suites'>Module 5 - Cipher Suites</a>
          </h1>
        </div>
      </div>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div id="content" class="col-md-12">
        <h2 id="cipher-suites-0357">5.1 Cipher Suites (03:57)</h2>
<p>到目前為止我們知道要建立一個安全的連線總共需要以下幾的組件:
Authentication: 確認 Server 的身分。
Symmetric Encryption: 保證傳送批量資料的機密性。
Hashing Algorithm: 使用 MAC 保證資料的 Integrity。
Key Exchange Protocol: 產生與交換必要的密鑰。</p>
<p>上面這四種組件可以任意組合成一個 Cipher Suites:
TLS_DHE_RSA_WITH_AES_256_CBC_SHA
TLS_DH_DSS_WITH_3DES_EDE_CBC_SHA
TLS_RSA_WITH_RC4_128_MD5: Authentication 與 Symmetric Encryption 都使用 RSA
TLS_NULL_WITH_NULL_NULL 最不安全
TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 最安全</p>
<p>當 Client 與 Server 在溝通時並不是在這四個組件中一個一個挑選，而是透過 IANA 預先定義的清單直接選擇 Cipher Suites</p>
<p>Cipher Suites are defined by IANA:
<code>https://www.iana.org/assignments/tls-parameters/tls-parameters.txt</code></p>
<h2 id="cs-key-exchange-part-1-0741">5.2 CS - Key Exchange - Part 1 (07:41)</h2>
<p>下面是經常使用到的 <code>Key Exchange</code>
ECDHE
DHE
ECDH
DH
RSA
PSK</p>
<p><code>Key Exchange</code> 的用途就是透過一個隨機二進制的 Seed 值產生一組 Symmetric Session Key。
<code>Key Exchange</code> 在運作的時候會使用到 Asymmetric Key 來交換 Seed 值，雖然這種方式比較慢，但好處就是只需要交換一次就能產生無數的 Key。</p>
<h3 id="psk-pre-shared-key">PSK - Pre-shared-Key</h3>
<p>是在建立 TLS 握手之前，雙方私底下就協議好了一個 Seed 值。
是最不安全的，但好處是完全不需要 Asymmetric Key 來交換 Seed 值的過程，也就代表不需要 CPU 運算。
可能會在 IOT 這種 CPU 非常寶貴的設備中發現 PSK。</p>
<h3 id="rsa">RSA</h3>
<p>這個方是已經提到過很多次的 <code>Hybrid Encryption</code>，就是 Client 先產生一個隨機的 Seed 值，並使用 Server 證書中的 Public Key 進行非對稱加密
並傳送給 Server，等 Server 收到之後就使用自己的 Private Key 進行解密並獲得 Seed 值，並開始產生溝通用 Symmetric Key。</p>
<p>缺點就是這個 Seed 值只有用 Private Key 進行加密保護，所以知道這個 Private Key 的人都可以知道 Seed 值，另外一個就是 Client 使用的
Seed 隨機產生器需要非常安全，否則可能被暴力破解並得出 Seed 值，這種情況就會略過 RSA 的保護。</p>
<h3 id="diffie-hellman">Diffie-Hellman</h3>
<p>透過不安全的中間層來建立與交換 Shared Secret，最後再用 Shared Secret 產生出 Seed。</p>
<p>優點是雙方都要使用亂數產生器，這樣會比只有一邊使用產生器安全。</p>
<p>DH: Diffie-Hellman。
EC...: Elliptic Curve，有 EC 代表執行效率會比較高。
...E: Ephemeral 產生初始參數是一個臨時的值，也就是初始值全都是隨機生成，沒有 E 結尾的初始參數都是固定的。</p>
<p>所以 ECDHE 與 DHE 是比較安全常用的。</p>
<h2 id="cs-forward-secrecy-key-exchange-part-2-0627">5.3 CS - Forward Secrecy - Key Exchange - Part 2 (06:27)</h2>
<p>Forward Secrecy 代表 Server 的 Private Key 外洩時不會導致過去建立的 Session Key 一起外洩，
也就是未來如果 Private Key 被外洩，那麼過去加密的資料是不會受影響的。</p>
<p>DH、ECDH 因為初始值是固定的，所以 P 跟 G 值其實是保存在 Certificate 內部的，所以只要 Private Key 外洩就能還原出 Session Key，
而且這個 Session Key 是根據固定的 P 跟 G 值算出來的所以並不會隨著時間改變，也就導致過去的資料也會被破解。</p>
<p>PSK、RSA、DH、ECDH 都沒有 Forward Secrecy 特性。</p>
<p>DHE、ECDHE 具有 Forward Secrecy 特性。</p>
<p>原理是 P 跟 G 值建立出初始的 Seed 值後就會拋棄初始值 P 跟 G 值。
所以只要加密一次就會永久加密。</p>
<p>TLS1.3 要求建立的 Session Key 都要具備 Forward Secrecy 特性。</p>
<h2 id="cs-authentication-0810">5.4 CS - Authentication (08:10)</h2>
<p>Authentication 是用來確認 Server 的身分。
下面是經常使用到的 <code>Authentication</code>
ECDSA
RSA
DSS
PSK</p>
<h3 id="psk-pre-shared-key-1">PSK - Pre-shared-Key</h3>
<p>雙方私底下協議好了一個 Key 值。
是最不安全的，但好處是完全不需要 Asymmetric Key 來交換 Key 值的過程，也就代表不需要 CPU 運算。
可能會在 IOT 這種 CPU 非常寶貴的設備中發現 PSK。</p>
<h3 id="asymmetric">Asymmetric</h3>
<p>其他的三種都是使用 Public Key 來驗證 Server 是否有對應的 Private Key。
ECDSA - Elliptic Curve Digital Signature Algorithm
RSA - Rivest Shamir Adelman
DSS - Digital Signature Standard</p>
<p>DSS == DSA，所以總共只有 RSA, DSA, EC 版 DSA。</p>
<p>RSA 跟 DSA 如果 Key 長度是相同的那安全性也是相同的。
以前 DSA 有強制限定長度需要是 1024 bits，但是這個規定現在已經拿掉了，不過還是有許多人還在用 DSA 1024 bits，RSA 則是一值都支援所有長度的 Key。
DSA 計算過程需要一個沒有使用過的隨機值，如果共用隨機值那可能會用來破解以前的訊息，雖然現在已經修正，RSA 則是沒有這種弱點出現過。
所以應該優先選 RSA。</p>
<p>因為 ECDSA 是比較新的規範，所以 RSA 支援度比較廣。
下面分別的 Key 長度所代表安全性是相同的。
RSA-1024 == ECDSA-160
RSA-2048 == ECDSA-224
RSA-3072 == ECDSA-256</p>
<p>可以看出來 ECDSA 只需要比較短的 Key 就能達到與 RSA 相同的安全性，並且 ECDSA 要獲得更高的安全性只要稍微增加 Key 的長度即可。</p>
<p>所以 RSA 跟 ECDSA 之間應該選擇 ECDSA。</p>
<p>不過可以 Cipher Suites 來同時支援兩種方式。</p>
<h2 id="cs-encryption-part-1-1527">5.5 CS - Encryption - Part 1 (15:27)</h2>
<p>Encryption 是用來產生 Symmetric Key 保護傳輸批量資料用的。
下面是經常使用到的 <code>Encryption</code>
CHACHA20
AES-256-GCM
AES-128-GCM
AES-256-CBC
AES-128-CBC
3DES-CBC
RC4-128
DES-CBC</p>
<p>Stream Ciphers:</p>
<ul>
<li>CHACHA20</li>
<li>RC4-128</li>
</ul>
<p>Block Ciphers:</p>
<ul>
<li>AES-256</li>
<li>AES-128</li>
<li>3DES</li>
<li>DES</li>
</ul>
<p>Block Cipher Modes:</p>
<ul>
<li>-CBC</li>
<li>-GCM</li>
</ul>
<h1 id="block-ciphers">Block Ciphers</h1>
<p>把傳進來的訊息切成多個 block 並將這個 block 轉換成密文。
因為 PC 都有內建的 AES 晶片，所以運算會很快。
加密後的內容可能會被推導出，因為兩個相同的句子所產生出的密文會是相同的，所以必須要搭配 operation mode，
以一張圖片來說，所有白色的像素會加密成一樣的密文，所有黑色的像素會加密成一樣的密文，最後產生出來的圖片還是能看出原始的樣貌只是顏色不一樣。</p>
<p>預設的 operation mode 是使用 ECB 模式所以不安全。
建議是使用 CBC 或 CTR</p>
<h3 id="block-cipher-mode-cbc-cipher-block-chaining">Block Cipher Mode: CBC-Cipher Block Chaining</h3>
<p>原理就是一個 Block 除了原始訊息外還要跟前一個 Block 的密文一起加密，也就是加密 Block 3 的時候需要 Block 2 的密文還有 Block 3 的原文。</p>
<p>第一個 Block 1 密文則是需要跟 Initialization Vector (IV) 一起加密後得出。</p>
<p>需要注意最後一個 Block 的長度可能跟其他 Block 不一樣長，所以最後一個 Block 通常會加上 padding 來避免 <code>padding oracle</code> 攻擊。</p>
<p>CBC 沒有辦法平行運算，因為每個 Block 都要依賴前一個 Block 的結果，所以多核心沒辦法加速 CBC。</p>
<h3 id="block-cipher-mode-ctr-counter-mode">Block Cipher Mode: CTR - Counter Mode</h3>
<p>原理是每個 Block 加密時都要搭配一個 nonce，但是每個 Block 都需要一個 nonce 要花費非常多的 CPU 時間。</p>
<p>所以實務上是產生一個 nonce 並且加上流水編號，這樣就只要產生一次就好。</p>
<p>但是這種計算方式就有跟 Stream Ciphers 一樣的缺點，就是順序非常重要不能錯亂，所以必須搭配 MAC 檢查。</p>
<p>最大的好處就是可以平行運算。</p>
<p>GCM - Galois Counter Mode 就是有內建 MAC 的 CTR。</p>
<p>AES-256-GCM AES-128-GCM 這種方式就叫做 <code>AEAD</code>
AEAD - Authenticated Encryption with Associated Data
因為它同實做了 Symmetric Encryption 與 MAC 兩件事情。</p>
<h1 id="stream-ciphers">Stream Ciphers</h1>
<p>把傳進來的每個 bit 都轉換成密文。
因為手機或 IOT 裝置沒有專門的 AES 晶片，所以這種類型的裝置使用 Stream Ciphers 比較快。
密文的順序分常重要，必須要搭配 MAC 來檢查 Integrity。</p>
<h2 id="cs-encryption-part-2-0719">5.6 CS - Encryption - Part 2 (07:19)</h2>
<h2 id="cs-hashing-0756">5.7 CS - Hashing (07:56)</h2>
<h2 id="cipher-suites-avoid-accept-prefer-0749">5.8 Cipher Suites - Avoid, Accept, Prefer (07:49)</h2>
<h2 id="enumerating-cipher-suites-0714">5.9 Enumerating Cipher Suites (07:14)</h2>

        

      </div>
    </div>
  </div>

  <hr>

  <!-- Footer -->
  <footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <p class="copyright">&#xA9; 2024 by Allen Gao</p>

      </div>
    </div>
  </div>
</footer>


  <!-- Scripts -->
  <script async src='/vendor/bootstrap/js/bootstrap.bundle.min1.js'></script>
  <script async src='/vendor/startbootstrap-clean-blog/js/scripts.js'></script>
  

  

</body>

</html>
